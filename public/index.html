<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>呆呆鸟酒馆</title>
    <link href="https://fonts.googleapis.com/css2?family=ZCOOL+KuaiLe&family=Nunito:wght@400;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --primary-brown: #8d6e63;
            --accent-orange: #ffab91;
            --bg-cream: #fff8e1;
            --text-dark: #5d4037;
            --text-light: #a1887f;
            --success-green: #81c784;
            --error-red: #e57373;
            --shadow-color: rgba(93, 64, 55, 0.3);
        }

        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
            user-select: none;
            -webkit-tap-highlight-color: transparent;
        }

        body {
            background-color: var(--bg-cream);
            background-image: radial-gradient(var(--accent-orange) 8%, transparent 8%);
            background-size: 30px 30px;
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            font-family: 'Nunito', 'ZCOOL KuaiLe', sans-serif;
            color: var(--text-dark);
            padding: 15px;
            overflow-x: hidden;
        }

        .app-container {
            width: 100%;
            max-width: 360px;
            background: #fffdf5;
            border: 3px solid var(--primary-brown);
            border-radius: 30px;
            box-shadow: 8px 8px 0 var(--primary-brown);
            padding: 25px 20px;
            position: relative;
            z-index: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        .header {
            width: 100%;
            display: flex;
            flex-direction: column;
            align-items: center;
            margin-bottom: 20px;
        }

        .avatar-wrapper {
            width: 110px;
            height: 110px;
            background: linear-gradient(135deg, var(--accent-orange), var(--primary-brown));
            border: 4px solid var(--primary-brown);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-bottom: 15px;
            position: relative;
            overflow: hidden;
            animation: float 3s ease-in-out infinite;
            box-shadow: 0 8px 20px var(--shadow-color);
        }

        .avatar-wrapper img {
            width: 100%;
            height: 100%;
            object-fit: cover;
            border-radius: 50%;
        }

        @keyframes float {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-8px); }
        }

        h1 {
            font-family: 'ZCOOL KuaiLe', cursive;
            font-size: 26px;
            color: var(--primary-brown);
            margin: 8px 0;
            letter-spacing: 2px;
            text-shadow: 2px 2px 0 var(--accent-orange);
        }

        .subtitle {
            font-size: 13px;
            color: var(--text-light);
            margin-bottom: 12px;
        }

        .status-badge {
            background: #fffdf5;
            border: 2px solid var(--primary-brown);
            padding: 8px 18px;
            border-radius: 25px;
            font-size: 14px;
            display: flex;
            align-items: center;
            gap: 10px;
            box-shadow: 3px 3px 0 var(--shadow-color);
            cursor: pointer;
            transition: all 0.2s;
        }

        .status-badge:active {
            transform: scale(0.95);
        }

        .status-badge.online {
            border-color: var(--success-green);
            background: #f1f8e9;
        }

        .status-dot {
            width: 12px;
            height: 12px;
            background: #bdbdbd;
            border-radius: 50%;
            position: relative;
        }

        .status-dot.active {
            background: var(--success-green);
            animation: pulse 1.5s infinite;
        }

        .status-dot.active::after {
            content: "";
            position: absolute;
            width: 100%;
            height: 100%;
            background: var(--success-green);
            border-radius: 50%;
            animation: ripple 1.5s infinite;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.6; }
        }

        @keyframes ripple {
            0% { transform: scale(1); opacity: 0.5; }
            100% { transform: scale(2.5); opacity: 0; }
        }

        .main-action {
            width: 100%;
            margin: 20px 0 25px;
        }

        .btn-group {
            display: flex;
            gap: 12px;
            width: 100%;
        }

        .btn-3d {
            flex: 1;
            background: var(--accent-orange);
            border: 3px solid var(--primary-brown);
            border-radius: 15px;
            padding: 16px 12px;
            font-family: 'ZCOOL KuaiLe', cursive;
            font-size: 16px;
            cursor: pointer;
            position: relative;
            box-shadow: 0 6px 0 var(--primary-brown);
            transition: all 0.1s;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            color: var(--text-dark);
            font-weight: bold;
        }

        .btn-3d:active {
            transform: translateY(6px);
            box-shadow: 0 0 0 var(--primary-brown);
        }

        .btn-3d:disabled {
            opacity: 0.6;
            background: #d7ccc8 !important;
            cursor: not-allowed;
            transform: translateY(6px);
            box-shadow: none;
        }

        .btn-primary {
            background: var(--accent-orange);
        }

        .btn-success {
            background: var(--success-green);
        }

        .btn-danger {
            background: var(--error-red);
            color: white;
        }

        .btn-info {
            background: #90caf9;
        }

        .icon-emoji {
            font-size: 20px;
        }

        .grid-menu {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 15px;
            width: 100%;
        }

        .menu-item {
            background: #fffdf5;
            border: 2px solid var(--primary-brown);
            border-radius: 18px;
            padding: 18px 12px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.2s;
            box-shadow: 4px 4px 0 var(--shadow-color);
        }

        .menu-item:hover {
            transform: translateY(-4px);
            box-shadow: 4px 8px 0 var(--shadow-color);
            background: var(--bg-cream);
        }

        .menu-item:active {
            transform: translateY(0);
            box-shadow: 2px 2px 0 var(--shadow-color);
        }

        .menu-icon {
            font-size: 32px;
            margin-bottom: 8px;
        }

        .menu-text {
            font-family: 'ZCOOL KuaiLe', cursive;
            font-size: 14px;
            color: var(--text-dark);
        }

        .footer-deco {
            margin-top: 25px;
            font-size: 12px;
            color: var(--text-light);
            text-align: center;
            width: 100%;
        }

        .footer-bird {
            display: inline-block;
            animation: float 2s ease-in-out infinite;
        }

        /* Toast */
        .toast {
            position: fixed;
            bottom: 30px;
            left: 50%;
            transform: translateX(-50%) translateY(100px);
            background: var(--primary-brown);
            color: white;
            border-radius: 25px;
            padding: 12px 24px;
            font-size: 14px;
            border: none;
            box-shadow: 0 5px 20px var(--shadow-color);
            z-index: 999;
            opacity: 0;
            transition: all 0.3s;
        }

        .toast.show {
            transform: translateX(-50%) translateY(0);
            opacity: 1;
        }

        .toast.success {
            background: var(--success-green);
            color: var(--text-dark);
        }

        .toast.error {
            background: var(--error-red);
            color: white;
        }

        /* Modal */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(93, 64, 55, 0.6);
            backdrop-filter: blur(3px);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 200;
            opacity: 0;
            visibility: hidden;
            transition: all 0.3s;
        }

        .modal-overlay.show {
            opacity: 1;
            visibility: visible;
        }

        .modal {
            background: #fffdf5;
            border: 3px solid var(--primary-brown);
            border-radius: 25px;
            box-shadow: 10px 10px 0 var(--shadow-color);
            width: 90%;
            max-width: 350px;
            max-height: 80vh;
            display: flex;
            flex-direction: column;
            transform: scale(0.8);
            transition: all 0.3s cubic-bezier(0.34, 1.56, 0.64, 1);
        }

        .modal-overlay.show .modal {
            transform: scale(1);
        }

        .modal-header {
            background: var(--accent-orange);
            padding: 15px 18px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 3px solid var(--primary-brown);
            border-radius: 22px 22px 0 0;
        }

        .modal-header h2 {
            font-family: 'ZCOOL KuaiLe', cursive;
            font-size: 18px;
            color: var(--text-dark);
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .modal-close {
            background: var(--error-red);
            border: 2px solid var(--primary-brown);
            width: 30px;
            height: 30px;
            border-radius: 50%;
            color: white;
            font-size: 18px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
        }

        .modal-body {
            padding: 20px;
            overflow-y: auto;
            font-size: 14px;
        }

        .modal-footer {
            padding: 15px;
            border-top: 2px dashed var(--text-light);
            display: flex;
            justify-content: flex-end;
            gap: 10px;
        }

        .form-input {
            width: 100%;
            padding: 12px 15px;
            border: 2px solid var(--text-light);
            border-radius: 12px;
            font-family: inherit;
            font-size: 14px;
            outline: none;
            transition: 0.3s;
            background: #fffdf5;
        }

        .form-input:focus {
            border-color: var(--primary-brown);
            box-shadow: 0 0 0 3px rgba(141, 110, 99, 0.2);
        }

        .toggle-switch {
            position: relative;
            width: 50px;
            height: 26px;
            display: inline-block;
        }

        .toggle-switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }

        .toggle-slider {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: #d7ccc8;
            border-radius: 26px;
            border: 2px solid var(--primary-brown);
            transition: 0.3s;
            cursor: pointer;
        }

        .toggle-slider:before {
            content: "";
            position: absolute;
            width: 18px;
            height: 18px;
            left: 2px;
            bottom: 2px;
            background: white;
            border-radius: 50%;
            border: 2px solid var(--primary-brown);
            transition: 0.3s;
        }

        .toggle-switch input:checked + .toggle-slider {
            background: var(--success-green);
        }

        .toggle-switch input:checked + .toggle-slider:before {
            transform: translateX(24px);
        }

        .version-list {
            max-height: 200px;
            overflow-y: auto;
        }

        .version-item {
            display: flex;
            align-items: center;
            padding: 12px;
            margin: 8px 0;
            background: #fffdf5;
            border-radius: 12px;
            border: 2px solid transparent;
            cursor: pointer;
            transition: 0.2s;
        }

        .version-item:hover {
            background: var(--bg-cream);
        }

        .version-item.active {
            border-color: var(--success-green);
            background: #f1f8e9;
        }

        .version-main {
            flex: 1;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .version-name {
            font-weight: bold;
            color: var(--text-dark);
        }

        .version-status {
            font-size: 12px;
            color: var(--text-light);
            padding: 3px 10px;
            background: #efebe9;
            border-radius: 10px;
        }

        .version-status.ready {
            background: var(--success-green);
            color: var(--text-dark);
        }

        .version-uninstall {
            width: 26px;
            height: 26px;
            background: var(--error-red);
            border: none;
            border-radius: 50%;
            color: white;
            cursor: pointer;
            margin-left: 8px;
            font-size: 14px;
        }

        .setting-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 14px;
            background: #fffdf5;
            border-radius: 12px;
            margin-bottom: 12px;
            border: 1px solid #efebe9;
        }

        .channel-group {
            margin-bottom: 15px;
        }

        .channel-group-title {
            font-family: 'ZCOOL KuaiLe', cursive;
            font-weight: bold;
            margin-bottom: 8px;
            color: var(--text-dark);
        }

        .channel-item {
            padding: 10px 12px;
            background: #fffdf5;
            border-radius: 10px;
            margin: 5px 0;
            font-size: 12px;
            border: 1px solid #efebe9;
        }

        .log-entry {
            padding: 5px 0;
            font-size: 12px;
            font-family: 'Courier New', monospace;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }

        .log-entry.error {
            color: #ff6b6b;
        }

        .log-entry .time {
            color: #888;
        }

        .user-info-card {
            text-align: center;
            padding: 20px;
        }

        .user-avatar-large {
            font-size: 60px;
            margin-bottom: 10px;
        }

        .user-name {
            font-family: 'ZCOOL KuaiLe', cursive;
            font-size: 20px;
            font-weight: bold;
            color: var(--text-dark);
        }

        .user-email {
            font-size: 12px;
            color: var(--text-light);
        }

        .balance-card {
            background: linear-gradient(135deg, var(--accent-orange), var(--primary-brown));
            border-radius: 18px;
            padding: 20px;
            margin-top: 15px;
            text-align: center;
            border: 2px solid var(--primary-brown);
        }

        .balance-label {
            font-size: 12px;
            color: #fffdf5;
        }

        .balance-value {
            font-family: 'ZCOOL KuaiLe', cursive;
            font-size: 32px;
            font-weight: bold;
            color: #fffdf5;
        }

        .endpoint-box {
            background: var(--primary-brown);
            color: var(--bg-cream);
            padding: 12px;
            border-radius: 10px;
            font-family: 'Courier New', monospace;
            font-size: 12px;
            word-break: break-all;
            margin-top: 10px;
            cursor: pointer;
        }

        ::-webkit-scrollbar {
            width: 6px;
        }

        ::-webkit-scrollbar-track {
            background: transparent;
        }

        ::-webkit-scrollbar-thumb {
            background: var(--accent-orange);
            border-radius: 10px;
        }

        @keyframes spin {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }
    </style>
</head>
<body>
    <div class="app-container">
        <header class="header">
            <div class="avatar-wrapper">
                <img src="https://youke1.picui.cn/s1/2025/11/25/6925988c61444.jpg" alt="呆呆鸟" onerror="this.style.display='none'">
            </div>
            <h1>呆呆鸟酒馆</h1>
            <div class="subtitle">SillyTavern Launcher v1.1</div>

            <div class="status-badge" id="statusBadge">
                <div class="status-dot" id="statusDot"></div>
                <span id="statusText">休息中...</span>
            </div>
        </header>

        <div class="main-action">
            <div class="btn-group" id="offlineButtons" style="display: flex;">
                <button class="btn-3d btn-primary" id="startBtn">
                    <span class="icon-emoji">&#127866;</span>
                    开张营业
                </button>
            </div>
            <div class="btn-group" id="loadingButtons" style="display: none;">
                <button class="btn-3d" disabled>
                    <span class="icon-emoji" style="animation: spin 1s linear infinite; display: inline-block;">&#9203;</span>
                    准备中...
                </button>
            </div>
            <div class="btn-group" id="onlineButtons" style="display: none;">
                <button class="btn-3d btn-success" id="enterBtn">
                    <span class="icon-emoji">&#128233;</span>
                    进入酒馆
                </button>
                <button class="btn-3d btn-danger" id="stopBtn">
                    <span class="icon-emoji">&#128164;</span>
                    打烊
                </button>
            </div>
        </div>

        <div class="grid-menu">
            <div class="menu-item" id="settingsBtn">
                <div class="menu-icon">&#9881;&#65039;</div>
                <div class="menu-text">酒馆设置</div>
            </div>
            <div class="menu-item" id="accountBtn">
                <div class="menu-icon">&#128100;</div>
                <div class="menu-text" id="accountText">账号绑定</div>
            </div>
            <div class="menu-item" id="channelBtn">
                <div class="menu-icon">&#9729;&#65039;</div>
                <div class="menu-text">渠道信息</div>
            </div>
            <div class="menu-item" id="logsBtn">
                <div class="menu-icon">&#128220;</div>
                <div class="menu-text">运行日志</div>
            </div>
        </div>

        <div style="display: flex; gap: 10px; width: 100%; margin-top: 15px;">
            <div class="menu-item" id="daidaiBtn" style="flex: 1;">
                <div class="menu-icon">&#127758;</div>
                <div class="menu-text">API站</div>
            </div>
            <div class="menu-item" id="profileBtn" style="flex: 1;">
                <div class="menu-icon">&#128522;</div>
                <div class="menu-text">我的</div>
            </div>
        </div>

        <footer class="footer-deco">
            <div>Made with <span class="footer-bird">&#128038;</span> by 呆呆鸟</div>
            <div id="versionInfo" style="opacity: 0.6; margin-top: 5px;">v1.1.0</div>
        </footer>
    </div>

    <div class="toast" id="toast"></div>

    <!-- 登录弹窗 -->
    <div class="modal-overlay" id="loginModal">
        <div class="modal">
            <div class="modal-header">
                <h2>&#128273; 绑定账号</h2>
                <div class="modal-close" id="loginClose">&times;</div>
            </div>
            <div class="modal-body">
                <div style="margin-bottom: 15px;">
                    <label style="display:block; margin-bottom:8px; font-size:13px; color:var(--text-light);">&#9993; 邮箱</label>
                    <input type="email" class="form-input" id="loginEmail" placeholder="name@example.com">
                </div>
                <div style="margin-bottom: 15px;">
                    <label style="display:block; margin-bottom:8px; font-size:13px; color:var(--text-light);">&#128274; 密码</label>
                    <input type="password" class="form-input" id="loginPassword" placeholder="********">
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn-3d btn-success" id="loginSubmit" style="padding: 10px 25px;">登录</button>
            </div>
        </div>
    </div>

    <!-- 设置弹窗 -->
    <div class="modal-overlay" id="versionModal">
        <div class="modal">
            <div class="modal-header">
                <h2>&#9881;&#65039; 酒馆设置</h2>
                <div class="modal-close" id="versionClose">&times;</div>
            </div>
            <div class="modal-body">
                <div style="margin-bottom: 15px;">
                    <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:12px;">
                        <span style="font-family:'ZCOOL KuaiLe',cursive; font-weight:bold;">&#128230; 版本管理</span>
                        <button class="btn-3d btn-info" id="rescanBtn" style="padding:6px 12px; font-size:12px;">扫描本地</button>
                    </div>
                    <div class="version-list" id="versionList">
                        <div style="text-align:center;padding:20px;color:var(--text-light);">加载中...</div>
                    </div>
                </div>

                <div class="setting-row">
                    <span>&#9889; 极速模式</span>
                    <label class="toggle-switch">
                        <input type="checkbox" id="speedOptToggle">
                        <span class="toggle-slider"></span>
                    </label>
                </div>

                <div class="setting-row" style="flex-direction:column; align-items:stretch;">
                    <div style="display:flex; justify-content:space-between; align-items:center;">
                        <span>&#128279; API聚合</span>
                        <label class="toggle-switch">
                            <input type="checkbox" id="aggregatorToggle">
                            <span class="toggle-slider"></span>
                        </label>
                    </div>
                    <div id="aggregatorEndpoint" style="display:none;">
                        <div class="endpoint-box" id="copyEndpoint">
                            <span id="aggregatorUrl">http://127.0.0.1:8080/v1</span>
                            <div style="font-size:10px; color:var(--accent-orange); margin-top:5px;">&#128203; 点击复制</div>
                        </div>
                        <div style="background:#f1f8e9;padding:10px;border-radius:10px;margin-top:10px;font-size:12px;border:2px dashed var(--success-green);">
                            <div style="font-weight:bold;color:var(--text-dark);margin-bottom:5px;">&#128273; API密钥</div>
                            <code style="background:#fffdf5;padding:3px 8px;border-radius:5px;color:var(--primary-brown);">daidaibird</code>
                        </div>
                        <div id="aggregatorStatus" style="font-size:12px; color:var(--success-green); margin-top:8px;"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- 渠道弹窗 -->
    <div class="modal-overlay" id="channelModal">
        <div class="modal">
            <div class="modal-header" style="background: var(--success-green);">
                <h2>&#128225; 可用渠道</h2>
                <div class="modal-close" id="channelClose">&times;</div>
            </div>
            <div class="modal-body" id="channelList">
                <div style="text-align:center; padding:30px; color:var(--text-light);">
                    <div style="font-size:40px;">&#128038;</div>
                    加载中...
                </div>
            </div>
        </div>
    </div>

    <!-- 日志弹窗 -->
    <div class="modal-overlay" id="logModal">
        <div class="modal" style="max-width: 400px;">
            <div class="modal-header" style="background: var(--error-red);">
                <h2 style="color:white;">&#128220; 运行日志</h2>
                <div class="modal-close" id="logClose">&times;</div>
            </div>
            <div class="modal-body" style="background: #3e2723; color: #a5d6a7; font-family: 'Courier New', monospace; padding: 12px; border-radius: 12px; min-height: 200px; max-height: 300px; overflow-y: auto;" id="logContainer">
            </div>
            <div class="modal-footer">
                <button class="btn-3d btn-danger" id="clearLogs" style="padding: 8px 18px;">清空日志</button>
            </div>
        </div>
    </div>

    <!-- 个人信息弹窗 -->
    <div class="modal-overlay" id="profileModal">
        <div class="modal">
            <div class="modal-header" style="background: #90caf9;">
                <h2>&#128522; 我的信息</h2>
                <div class="modal-close" id="profileClose">&times;</div>
            </div>
            <div class="modal-body" id="profileBody">
                <div style="text-align:center; padding:30px; color:var(--text-light);">
                    未登录
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn-3d btn-danger" id="logoutBtn" style="display:none; padding: 8px 18px;">退出登录</button>
            </div>
        </div>
    </div>

    <script>
    (function() {
        'use strict';
        var API_BASE = '';
        var isRunning = false;
        var userToken = localStorage.getItem('userToken');
        var userInfo = null;
        try { userInfo = JSON.parse(localStorage.getItem('userInfo')); } catch(e) {}

        function showToast(msg, type) {
            var toast = document.getElementById('toast');
            toast.textContent = msg;
            toast.className = 'toast show' + (type ? ' ' + type : '');
            setTimeout(function() { toast.className = 'toast'; }, 3000);
        }

        function updateStatus() {
            fetch(API_BASE + '/api/status')
                .then(function(res) { return res.json(); })
                .then(function(data) {
                    isRunning = data.running;
                    var badge = document.getElementById('statusBadge');
                    var dot = document.getElementById('statusDot');
                    var text = document.getElementById('statusText');

                    if (data.running) {
                        badge.classList.add('online');
                        dot.classList.add('active');
                        text.textContent = '营业中~';
                        document.getElementById('offlineButtons').style.display = 'none';
                        document.getElementById('loadingButtons').style.display = 'none';
                        document.getElementById('onlineButtons').style.display = 'flex';
                    } else {
                        badge.classList.remove('online');
                        dot.classList.remove('active');
                        text.textContent = '休息中...';
                        document.getElementById('offlineButtons').style.display = 'flex';
                        document.getElementById('loadingButtons').style.display = 'none';
                        document.getElementById('onlineButtons').style.display = 'none';
                    }

                    if (data.version) {
                        document.getElementById('versionInfo').textContent = 'ST ' + (data.version.agent || data.activeVersion || '');
                    }
                })
                .catch(function(err) {
                    console.error('Status check failed:', err);
                });
        }

        function startServer() {
            document.getElementById('offlineButtons').style.display = 'none';
            document.getElementById('loadingButtons').style.display = 'flex';

            fetch(API_BASE + '/api/start', { method: 'POST' })
                .then(function(res) { return res.json(); })
                .then(function(data) {
                    if (data.success) {
                        showToast('开张啦~', 'success');
                        setTimeout(updateStatus, 1000);
                    } else {
                        showToast(data.message, 'error');
                        document.getElementById('offlineButtons').style.display = 'flex';
                        document.getElementById('loadingButtons').style.display = 'none';
                    }
                })
                .catch(function(err) {
                    showToast('启动失败: ' + err.message, 'error');
                    document.getElementById('offlineButtons').style.display = 'flex';
                    document.getElementById('loadingButtons').style.display = 'none';
                });
        }

        function stopServer() {
            fetch(API_BASE + '/api/stop', { method: 'POST' })
                .then(function(res) { return res.json(); })
                .then(function(data) {
                    if (data.success) {
                        showToast('已打烊~', 'success');
                        updateStatus();
                    } else {
                        showToast(data.message, 'error');
                    }
                });
        }

        function enterST() {
            if (!isRunning) {
                showToast('请先开张营业~', 'info');
                return;
            }
            window.open('http://127.0.0.1:8000', '_blank');
        }

        function updateAccountUI() {
            var text = document.getElementById('accountText');
            if (userInfo && userInfo.userEmail) {
                text.textContent = '已绑定';
            } else {
                text.textContent = '账号绑定';
            }
        }

        function doLogin() {
            var email = document.getElementById('loginEmail').value;
            var pwd = document.getElementById('loginPassword').value;
            if (!email || !pwd) {
                showToast('请填写完整~', 'error');
                return;
            }
            showToast('登录中...', 'info');
            fetch('https://user.daidaibird.top/api/users/login', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ userEmail: email, password: pwd })
            })
            .then(function(res) { return res.json(); })
            .then(function(data) {
                if (data.code === 200) {
                    userToken = data.token;
                    userInfo = data.msg;
                    localStorage.setItem('userToken', userToken);
                    localStorage.setItem('userInfo', JSON.stringify(userInfo));
                    showToast('绑定成功！', 'success');
                    document.getElementById('loginModal').classList.remove('show');
                    updateAccountUI();
                } else {
                    showToast('登录失败：' + (data.msg || '未知错误'), 'error');
                }
            })
            .catch(function(err) {
                showToast('登录失败：' + err.message, 'error');
            });
        }

        function loadVersions() {
            var list = document.getElementById('versionList');
            list.innerHTML = '<div style="text-align:center;padding:20px;color:var(--text-light);">加载中...</div>';
            fetch(API_BASE + '/api/versions')
                .then(function(res) { return res.json(); })
                .then(function(data) {
                    var html = '';
                    data.versions.forEach(function(v) {
                        var isLocal = v.isLocal || v.version.startsWith('local_');
                        var statusText = v.installed ? (v.active ? '当前' : (isLocal ? '本地' : '已装')) : '需装';
                        var statusClass = v.installed ? 'ready' : '';
                        var activeClass = v.active ? 'active' : '';
                        var canUninstall = v.installed && !v.active && !isLocal;
                        html += '<div class="version-item ' + activeClass + '">' +
                            '<div class="version-main" data-version="' + v.version + '" data-installed="' + v.installed + '">' +
                            '<span class="version-name">' + v.name + '</span>' +
                            '<span class="version-status ' + statusClass + '">' + statusText + '</span>' +
                            '</div>';
                        if (canUninstall) {
                            html += '<button class="version-uninstall" data-version="' + v.version + '">&times;</button>';
                        }
                        html += '</div>';
                    });
                    list.innerHTML = html;
                    list.querySelectorAll('.version-main').forEach(function(item) {
                        item.addEventListener('click', function() {
                            var version = this.getAttribute('data-version');
                            var installed = this.getAttribute('data-installed') === 'true';
                            selectVersion(version, installed);
                        });
                    });
                    list.querySelectorAll('.version-uninstall').forEach(function(btn) {
                        btn.addEventListener('click', function(e) {
                            e.stopPropagation();
                            uninstallVersion(this.getAttribute('data-version'));
                        });
                    });
                });
        }

        function rescanLocal() {
            showToast('扫描中...', 'info');
            fetch(API_BASE + '/api/versions/rescan', { method: 'POST' })
                .then(function(res) { return res.json(); })
                .then(function(data) {
                    showToast(data.message, 'success');
                    loadVersions();
                });
        }

        function uninstallVersion(version) {
            if (isRunning) {
                showToast('请先打烊~', 'error');
                return;
            }
            if (!confirm('确定卸载 ' + version + '？\n\n请先备份data文件夹！')) return;
            fetch(API_BASE + '/api/versions/uninstall', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ version: version })
            })
            .then(function(res) { return res.json(); })
            .then(function(data) {
                showToast(data.success ? '已卸载' : data.message, data.success ? 'success' : 'error');
                if (data.success) loadVersions();
            });
        }

        function selectVersion(version, installed) {
            if (isRunning) {
                showToast('请先打烊~', 'error');
                return;
            }
            if (!installed) {
                if (!confirm('是否安装 ' + version + '？\n（需要一些时间）')) return;
                showToast('开始安装...', 'info');
                fetch(API_BASE + '/api/versions/install', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ version: version })
                })
                .then(function(res) { return res.json(); })
                .then(function(data) {
                    showToast(data.success ? '安装成功！' : data.message, data.success ? 'success' : 'error');
                    loadVersions();
                });
                return;
            }
            fetch(API_BASE + '/api/versions/switch', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ version: version })
            })
            .then(function(res) { return res.json(); })
            .then(function(data) {
                showToast(data.success ? '已切换' : data.message, data.success ? 'success' : 'error');
                loadVersions();
            });
        }

        function loadSettings() {
            fetch(API_BASE + '/api/settings')
                .then(function(res) { return res.json(); })
                .then(function(data) {
                    document.getElementById('speedOptToggle').checked = data.speedOptimization;
                    var aggregatorToggle = document.getElementById('aggregatorToggle');
                    var aggregatorEndpoint = document.getElementById('aggregatorEndpoint');
                    var aggregatorStatus = document.getElementById('aggregatorStatus');
                    var isRunning = data.aggregator && data.aggregator.running;
                    aggregatorToggle.checked = isRunning;
                    if (isRunning) {
                        aggregatorEndpoint.style.display = 'block';
                        aggregatorStatus.textContent = '运行中 · ' + data.aggregator.keysCount + ' 密钥';
                        document.getElementById('aggregatorUrl').textContent = window.location.origin + data.aggregator.endpoint;
                    } else {
                        aggregatorEndpoint.style.display = 'none';
                    }
                });
        }

        function toggleSpeedOptimization(enable) {
            fetch(API_BASE + '/api/settings/speed-optimization', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ enable: enable })
            })
            .then(function(res) { return res.json(); })
            .then(function(data) {
                showToast(data.success ? data.message : data.message, data.success ? 'success' : 'error');
                if (!data.success) document.getElementById('speedOptToggle').checked = !enable;
            });
        }

        function toggleAggregator(enable) {
            if (enable) {
                if (!userInfo || !userToken) {
                    showToast('请先绑定账号~', 'error');
                    document.getElementById('aggregatorToggle').checked = false;
                    return;
                }
                fetch(API_BASE + '/api/aggregator/start', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ token: userToken, userInfo: userInfo })
                })
                .then(function(res) { return res.json(); })
                .then(function(data) {
                    if (data.success) {
                        showToast('已启动 · ' + data.keysCount + ' 密钥', 'success');
                        document.getElementById('aggregatorEndpoint').style.display = 'block';
                        document.getElementById('aggregatorStatus').textContent = '运行中 · ' + data.keysCount + ' 密钥';
                        document.getElementById('aggregatorUrl').textContent = window.location.origin + data.endpoint;
                    } else {
                        showToast(data.message, 'error');
                        document.getElementById('aggregatorToggle').checked = false;
                    }
                });
            } else {
                fetch(API_BASE + '/api/aggregator/stop', { method: 'POST' })
                .then(function(res) { return res.json(); })
                .then(function(data) {
                    showToast('已停止', 'success');
                    document.getElementById('aggregatorEndpoint').style.display = 'none';
                });
            }
        }

        function copyAggregatorEndpoint() {
            var url = document.getElementById('aggregatorUrl').textContent;
            navigator.clipboard.writeText(url).then(function() {
                showToast('已复制~', 'success');
            });
        }

        function loadLogs() {
            fetch(API_BASE + '/api/logs')
                .then(function(res) { return res.json(); })
                .then(function(data) {
                    var container = document.getElementById('logContainer');
                    if (!data.logs || data.logs.length === 0) {
                        container.innerHTML = '<div style="color:#888;text-align:center;padding:20px;">暂无日志~</div>';
                        return;
                    }
                    var html = '';
                    data.logs.forEach(function(log) {
                        var cls = log.type === 'error' || log.type === 'stderr' ? 'error' : '';
                        html += '<div class="log-entry ' + cls + '"><span class="time">[' + log.timestamp + ']</span> ' + log.message + '</div>';
                    });
                    container.innerHTML = html;
                    container.scrollTop = container.scrollHeight;
                });
        }

        function loadChannels() {
            var list = document.getElementById('channelList');
            list.innerHTML = '<div style="text-align:center;padding:30px;"><div style="font-size:40px;">&#128038;</div>加载中...</div>';
            if (!userInfo || !userToken || !userInfo.userId) {
                list.innerHTML = '<div style="text-align:center;padding:30px;color:var(--text-light);">请先登录查看渠道</div>';
                return;
            }
            fetch('https://user.daidaibird.top/api/commodity/getPricing', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json', 'Authorization': 'Bearer ' + userToken },
                body: JSON.stringify(userInfo)
            })
                .then(function(res) { return res.json(); })
                .then(function(data) {
                    if (data.code !== 200 || !data.msg || data.msg.length === 0) {
                        list.innerHTML = '<div style="text-align:center;padding:30px;color:var(--text-light);">暂无渠道</div>';
                        return;
                    }
                    var groups = {};
                    data.msg.forEach(function(m) {
                        var group = m.type || '其他';
                        if (!groups[group]) groups[group] = [];
                        groups[group].push(m);
                    });
                    var html = '';
                    for (var g in groups) {
                        var items = groups[g];
                        html += '<div class="channel-group"><div class="channel-group-title">' + g + ' (' + items.length + ')</div>';
                        items.forEach(function(m) {
                            var status = m.mac === '1' ? '&#9989;' : '&#128295;';
                            var title = m.title ? '[' + m.title + '] ' : '';
                            var price = m.num ? '&#165;' + (parseFloat(m.price) * parseFloat(m.num)).toFixed(2) + '/条' : '';
                            html += '<div class="channel-item" style="display:flex;justify-content:space-between;align-items:center;">' +
                                '<div><span>' + status + '</span> ' + title + m.module + '</div>' +
                                '<div style="font-size:10px;color:var(--success-green);">' + price + '</div>' +
                                '</div>';
                        });
                        html += '</div>';
                    }
                    list.innerHTML = html;
                })
                .catch(function() {
                    list.innerHTML = '<div style="text-align:center;padding:30px;color:var(--text-light);">加载失败</div>';
                });
        }

        function loadProfile() {
            var body = document.getElementById('profileBody');
            var logoutBtn = document.getElementById('logoutBtn');
            if (!userInfo || !userToken) {
                body.innerHTML = '<div style="text-align:center;padding:40px;color:var(--text-light);">未绑定账号~</div>';
                logoutBtn.style.display = 'none';
                return;
            }
            if (!userInfo.userId) {
                body.innerHTML = '<div style="text-align:center;padding:30px;color:var(--text-light);">' +
                    '<div style="font-size:40px;margin-bottom:10px;">&#128260;</div>' +
                    '<div>请退出后重新登录</div>' +
                    '<div style="font-size:12px;margin-top:5px;">(数据格式已更新)</div></div>';
                logoutBtn.style.display = 'block';
                return;
            }
            body.innerHTML = '<div style="text-align:center;padding:20px;">加载中...</div>';
            fetch('https://user.daidaibird.top/api/general/orders', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json', 'Authorization': 'Bearer ' + userToken },
                body: JSON.stringify({ userData: JSON.stringify(userInfo), page: 1 })
            })
            .then(function(res) { return res.json(); })
            .then(function(data) {
                if (data.code === 200 && data.msg) {
                    var keys = data.msg;
                    var totalBalance = 0;
                    keys.forEach(function(k) { totalBalance += parseFloat(k.balance) || 0; });
                    var keysHtml = '';
                    keys.forEach(function(k) {
                        keysHtml += '<div style="background:#fffdf5;padding:10px;border-radius:10px;margin:6px 0;font-size:12px;border:1px solid #efebe9;">' +
                            '<div style="font-family:monospace;word-break:break-all;">' + k.api_key.substring(0,20) + '...</div>' +
                            '<div style="color:var(--success-green);margin-top:5px;">余额: &#165;' + k.balance + '</div>' +
                            '</div>';
                    });
                    body.innerHTML = '<div class="user-info-card">' +
                        '<div class="user-avatar-large">&#128038;</div>' +
                        '<div class="user-name">' + userInfo.userEmail.split('@')[0] + '</div>' +
                        '<div class="user-email">' + userInfo.userEmail + '</div>' +
                        '</div>' +
                        '<div class="balance-card">' +
                        '<div class="balance-label">总余额</div>' +
                        '<div class="balance-value">&#165;' + totalBalance.toFixed(2) + '</div>' +
                        '</div>' +
                        '<div style="margin-top:15px;"><div style="font-family:\'ZCOOL KuaiLe\',cursive;font-weight:bold;margin-bottom:10px;">&#128273; API密钥 (' + keys.length + ')</div>' + keysHtml + '</div>';
                    logoutBtn.style.display = 'block';
                } else {
                    body.innerHTML = '<div style="text-align:center;padding:40px;color:var(--text-light);">获取信息失败</div>';
                }
            });
        }

        function logout() {
            if (!confirm('确定退出登录？')) return;
            localStorage.removeItem('userToken');
            localStorage.removeItem('userInfo');
            userToken = null;
            userInfo = null;
            showToast('已退出~', 'success');
            document.getElementById('profileModal').classList.remove('show');
            updateAccountUI();
        }

        // 初始化
        updateStatus();
        setInterval(updateStatus, 5000);
        updateAccountUI();

        // 事件绑定
        document.getElementById('startBtn').addEventListener('click', startServer);
        document.getElementById('stopBtn').addEventListener('click', stopServer);
        document.getElementById('enterBtn').addEventListener('click', enterST);

        document.getElementById('settingsBtn').addEventListener('click', function() {
            document.getElementById('versionModal').classList.add('show');
            loadVersions();
            loadSettings();
        });

        document.getElementById('accountBtn').addEventListener('click', function() {
            if (userInfo && userToken) {
                document.getElementById('profileModal').classList.add('show');
                loadProfile();
            } else {
                document.getElementById('loginModal').classList.add('show');
            }
        });

        document.getElementById('daidaiBtn').addEventListener('click', function() {
            window.open('https://www.daidaibird.top', '_blank');
        });

        document.getElementById('logsBtn').addEventListener('click', function() {
            document.getElementById('logModal').classList.add('show');
            loadLogs();
        });

        document.getElementById('channelBtn').addEventListener('click', function() {
            document.getElementById('channelModal').classList.add('show');
            loadChannels();
        });

        document.getElementById('profileBtn').addEventListener('click', function() {
            document.getElementById('profileModal').classList.add('show');
            loadProfile();
        });

        // 弹窗关闭
        document.getElementById('loginClose').addEventListener('click', function() {
            document.getElementById('loginModal').classList.remove('show');
        });
        document.getElementById('loginSubmit').addEventListener('click', doLogin);

        document.getElementById('versionClose').addEventListener('click', function() {
            document.getElementById('versionModal').classList.remove('show');
        });
        document.getElementById('rescanBtn').addEventListener('click', rescanLocal);
        document.getElementById('speedOptToggle').addEventListener('change', function() {
            toggleSpeedOptimization(this.checked);
        });
        document.getElementById('aggregatorToggle').addEventListener('change', function() {
            toggleAggregator(this.checked);
        });
        document.getElementById('copyEndpoint').addEventListener('click', copyAggregatorEndpoint);

        document.getElementById('logClose').addEventListener('click', function() {
            document.getElementById('logModal').classList.remove('show');
        });
        document.getElementById('clearLogs').addEventListener('click', function() {
            fetch(API_BASE + '/api/clear-logs', { method: 'POST' }).then(loadLogs);
        });

        document.getElementById('channelClose').addEventListener('click', function() {
            document.getElementById('channelModal').classList.remove('show');
        });

        document.getElementById('profileClose').addEventListener('click', function() {
            document.getElementById('profileModal').classList.remove('show');
        });
        document.getElementById('logoutBtn').addEventListener('click', logout);

        // 点击弹窗外部关闭
        document.querySelectorAll('.modal-overlay').forEach(function(overlay) {
            overlay.addEventListener('click', function(e) {
                if (e.target === overlay) overlay.classList.remove('show');
            });
        });
    })();
    </script>
</body>
</html>
