<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>å‘†å‘†é¸Ÿå°çª</title>
    <link rel="icon" type="image/jpeg" href="https://youke1.picui.cn/s1/2025/11/25/6925988c61444.jpg">
    <style>
        :root {
            --primary-brown: #8d6e63;
            --accent-orange: #ffab91;
            --bg-cream: #fff8e1;
            --text-color: #5d4037;
            --shadow-color: rgba(141, 110, 99, 0.2);
        }
        * { box-sizing: border-box; margin: 0; padding: 0; }
        body {
            background-color: var(--bg-cream);
            background-image: radial-gradient(#ffe0b2 1px, transparent 1px);
            background-size: 20px 20px;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            color: var(--text-color);
            display: flex;
            justify-content: center;
            min-height: 100vh;
            padding: 20px;
        }
        .app-container {
            width: 100%;
            max-width: 420px;
            background: rgba(255, 255, 255, 0.9);
            border-radius: 30px;
            padding: 30px 20px;
            box-shadow: 0 10px 30px var(--shadow-color);
            display: flex;
            flex-direction: column;
            align-items: center;
            position: relative;
        }
        .header { text-align: center; margin-bottom: 20px; }
        .avatar-wrapper {
            width: 100px;
            height: 100px;
            border-radius: 50%;
            border: 5px solid white;
            box-shadow: 0 8px 20px var(--shadow-color);
            overflow: hidden;
            margin: 0 auto 12px;
            animation: float 3s ease-in-out infinite;
        }
        .avatar-wrapper img { width: 100%; height: 100%; object-fit: cover; }
        h1 { font-size: 1.6rem; color: var(--primary-brown); margin-bottom: 5px; }
        .status-badge {
            display: inline-block;
            padding: 6px 16px;
            background: #ffebee;
            color: #c62828;
            border-radius: 20px;
            font-size: 0.85rem;
            font-weight: bold;
            border: 2px solid #ffcdd2;
            cursor: pointer;
        }
        .status-badge.online { background: #e8f5e9; color: #2e7d32; border-color: #c8e6c9; }
        .status-dot {
            display: inline-block;
            width: 8px;
            height: 8px;
            background-color: #ef5350;
            border-radius: 50%;
            margin-right: 5px;
        }
        .status-dot.active { background-color: #4caf50; animation: pulse 1.5s infinite; }
        .main-action { width: 100%; margin-bottom: 25px; }
        .btn-group { display: flex; gap: 10px; width: 100%; }
        .action-btn {
            flex: 1;
            padding: 15px 10px;
            border: none;
            border-radius: 20px;
            font-size: 1.1rem;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 5px;
        }
        .action-btn:disabled { opacity: 0.6; cursor: not-allowed; }
        .start-btn { background: var(--primary-brown); color: white; box-shadow: 0 5px 0 #5d4037; }
        .enter-btn { background: #4caf50; color: white; box-shadow: 0 5px 0 #388e3c; }
        .stop-btn { background: #ef5350; color: white; box-shadow: 0 5px 0 #c62828; }
        .loading-btn { background: var(--accent-orange); color: white; }
        .grid-menu { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; width: 100%; }
        .menu-item {
            background: white;
            border: 2px solid #efebe9;
            border-radius: 18px;
            padding: 12px;
            text-align: center;
            cursor: pointer;
            display: flex;
            flex-direction: column;
            align-items: center;
        }
        .menu-item:hover { border-color: var(--accent-orange); }
        .menu-icon { font-size: 1.3rem; margin-bottom: 5px; }
        .menu-text { font-size: 0.9rem; font-weight: bold; }
        .footer-deco { margin-top: 20px; font-size: 0.75rem; color: #a1887f; text-align: center; }
        .version-info { font-size: 0.7rem; color: #bcaaa4; margin-top: 3px; }
        @keyframes float { 0%, 100% { transform: translateY(0); } 50% { transform: translateY(-8px); } }
        @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.5; } }
        .toast {
            position: fixed;
            bottom: 30px;
            left: 50%;
            transform: translateX(-50%) translateY(100px);
            background: rgba(0,0,0,0.8);
            color: white;
            padding: 12px 24px;
            border-radius: 25px;
            opacity: 0;
            transition: all 0.3s;
            z-index: 1000;
        }
        .toast.show { transform: translateX(-50%) translateY(0); opacity: 1; }
        .toast.error { background: #ef5350; }
        .toast.success { background: #4caf50; }
        .modal-overlay {
            position: fixed;
            top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(0,0,0,0.5);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 200;
            opacity: 0;
            visibility: hidden;
            transition: all 0.3s;
        }
        .modal-overlay.show { opacity: 1; visibility: visible; }
        .modal {
            background: white;
            border-radius: 20px;
            width: 90%;
            max-width: 400px;
            max-height: 80vh;
            display: flex;
            flex-direction: column;
            transform: scale(0.9);
            transition: transform 0.3s;
        }
        .modal-overlay.show .modal { transform: scale(1); }
        .modal-header {
            padding: 18px 20px;
            border-bottom: 1px solid #eee;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .modal-header h2 { font-size: 1.1rem; color: var(--primary-brown); }
        .modal-close { background: none; border: none; font-size: 1.5rem; cursor: pointer; color: #999; }
        .modal-body { flex: 1; overflow-y: auto; padding: 20px; }
        .modal-footer { padding: 15px 20px; border-top: 1px solid #eee; display: flex; justify-content: flex-end; gap: 10px; }
        .modal-btn { padding: 10px 20px; border: none; border-radius: 15px; cursor: pointer; font-weight: bold; }
        .modal-btn.primary { background: var(--primary-brown); color: white; }
        .modal-btn.secondary { background: #efebe9; color: var(--text-color); }
        .form-group { margin-bottom: 15px; }
        .form-group label { display: block; margin-bottom: 5px; font-weight: bold; font-size: 0.9rem; }
        .form-group input {
            width: 100%;
            padding: 12px 15px;
            border: 2px solid #efebe9;
            border-radius: 12px;
            font-size: 1rem;
        }
        .form-group input:focus { outline: none; border-color: var(--accent-orange); }
        .log-container {
            font-family: monospace;
            font-size: 0.75rem;
            background: #263238;
            color: #aed581;
            padding: 15px;
            border-radius: 10px;
            max-height: 300px;
            overflow-y: auto;
        }
        .log-entry { margin-bottom: 4px; word-break: break-all; }
        .log-entry .time { color: #78909c; }
        .log-entry.error { color: #ef5350; }
        .version-list { display: flex; flex-direction: column; gap: 10px; }
        .version-item {
            display: flex;
            align-items: center;
            padding: 12px 15px;
            background: #fafafa;
            border: 2px solid #efebe9;
            border-radius: 12px;
            gap: 8px;
        }
        .version-item:hover { border-color: var(--accent-orange); }
        .version-item.active { border-color: #4caf50; background: #e8f5e9; }
        .version-main { flex: 1; display: flex; align-items: center; cursor: pointer; }
        .version-name { flex: 1; font-weight: bold; }
        .version-status { font-size: 0.8rem; color: #999; }
        .version-status.ready { color: #4caf50; }
        .version-uninstall {
            background: #ffebee;
            border: none;
            border-radius: 8px;
            padding: 6px 10px;
            cursor: pointer;
            font-size: 0.9rem;
            transition: all 0.2s;
        }
        .version-uninstall:hover { background: #ef5350; }
        .profile-section { margin-bottom: 20px; }
        .profile-section-title { font-weight: bold; color: var(--primary-brown); margin-bottom: 10px; font-size: 0.95rem; display: flex; align-items: center; gap: 6px; }
        .api-card { background: #f5f5f5; border-radius: 12px; padding: 12px; margin-bottom: 10px; border: 1px solid #e0e0e0; }
        .api-key { font-family: monospace; font-size: 0.75rem; background: #fff; padding: 8px; border-radius: 8px; word-break: break-all; color: #333; margin-bottom: 8px; border: 1px solid #ddd; }
        .api-stats { display: flex; gap: 15px; font-size: 0.85rem; }
        .api-stat { display: flex; align-items: center; gap: 4px; }
        .api-stat .label { color: #666; }
        .api-stat .value { font-weight: bold; }
        .api-stat .value.green { color: #4caf50; }
        .api-stat .value.orange { color: #ff9800; }
        .coupon-card { background: linear-gradient(135deg, #fff3e0, #ffe0b2); border-radius: 12px; padding: 12px; margin-bottom: 10px; border: 2px dashed #ffab91; }
        .coupon-name { font-weight: bold; color: #e65100; margin-bottom: 5px; }
        .coupon-value { font-size: 1.2rem; color: #ff5722; font-weight: bold; }
        .coupon-status { font-size: 0.8rem; color: #666; margin-top: 5px; }
        .no-data { text-align: center; color: #999; padding: 15px; font-size: 0.9rem; }
        .channel-tabs { display: flex; flex-wrap: wrap; gap: 6px; margin-bottom: 12px; }
        .channel-tab { padding: 6px 12px; border-radius: 15px; font-size: 0.8rem; cursor: pointer; border: 2px solid #e0e0e0; background: #fff; transition: all 0.2s; }
        .channel-tab:hover { border-color: var(--accent-orange); }
        .channel-tab.active { background: var(--primary-brown); color: white; border-color: var(--primary-brown); }
        .channel-list { max-height: 400px; overflow-y: auto; }
        .channel-card { background: #fff; border-radius: 12px; padding: 10px 12px; margin-bottom: 8px; border: 2px solid #e8e8e8; transition: all 0.2s; }
        .channel-card:hover { border-color: #ccc; }
        .channel-card.offline { opacity: 0.6; background: #fafafa; }
        .channel-header { display: flex; align-items: center; gap: 8px; margin-bottom: 6px; }
        .channel-status { width: 8px; height: 8px; border-radius: 50%; flex-shrink: 0; }
        .channel-status.online { background: #4caf50; }
        .channel-status.offline { background: #ff9800; }
        .channel-title { font-weight: bold; font-size: 0.9rem; color: #333; }
        .channel-tag { font-size: 0.7rem; padding: 2px 6px; border-radius: 8px; background: #e3f2fd; color: #1976d2; }
        .channel-model { font-size: 0.8rem; color: #666; margin-bottom: 4px; }
        .channel-desc { font-size: 0.75rem; color: #999; margin-bottom: 6px; line-height: 1.3; }
        .channel-price { font-size: 0.8rem; color: #e65100; font-weight: bold; }
        .settings-section { margin-bottom: 20px; }
        .settings-section:first-child { margin-top: 0; }
        .settings-section-title { font-weight: bold; color: var(--primary-brown); margin-bottom: 12px; font-size: 0.95rem; padding-bottom: 8px; border-bottom: 2px solid #efebe9; }
        .settings-item { display: flex; align-items: center; gap: 15px; padding: 12px; background: #fafafa; border-radius: 12px; margin-bottom: 10px; }
        .settings-item-info { flex: 1; }
        .settings-item-name { font-weight: bold; font-size: 0.9rem; color: #333; margin-bottom: 4px; }
        .settings-item-desc { font-size: 0.75rem; color: #666; line-height: 1.4; }
        .settings-item-endpoint { margin-top: 8px; font-size: 0.75rem; display: flex; align-items: center; gap: 6px; }
        .settings-item-endpoint code { background: #fff; padding: 4px 8px; border-radius: 6px; border: 1px solid #ddd; font-size: 0.7rem; }
        .settings-item-status { margin-top: 6px; font-size: 0.75rem; color: #4caf50; }
        .copy-btn { background: none; border: none; cursor: pointer; font-size: 0.9rem; padding: 2px; }
        .copy-btn:hover { transform: scale(1.2); }
        .toggle-switch { position: relative; display: inline-block; width: 48px; height: 26px; flex-shrink: 0; }
        .toggle-switch input { opacity: 0; width: 0; height: 0; }
        .toggle-slider { position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: #ccc; border-radius: 26px; transition: 0.3s; }
        .toggle-slider:before { position: absolute; content: ""; height: 20px; width: 20px; left: 3px; bottom: 3px; background-color: white; border-radius: 50%; transition: 0.3s; }
        .toggle-switch input:checked + .toggle-slider { background-color: #4caf50; }
        .toggle-switch input:checked + .toggle-slider:before { transform: translateX(22px); }
        .toggle-switch input:disabled + .toggle-slider { opacity: 0.5; cursor: not-allowed; }
    </style>
</head>
<body>
    <div class="app-container">
        <header class="header">
            <div class="avatar-wrapper">
                <img src="https://youke1.picui.cn/s1/2025/11/25/6925988c61444.jpg" alt="å‘†å‘†é¸Ÿ">
            </div>
            <h1>å‘†å‘†é¸Ÿå°çª</h1>
            <div class="status-badge" id="statusBadge">
                <span class="status-dot" id="statusDot"></span>
                <span id="statusText">æ£€æµ‹ä¸­...</span>
            </div>
        </header>

        <div class="main-action">
            <div class="btn-group" id="offlineButtons">
                <button class="action-btn start-btn" id="startBtn">âœ¨ å¯åŠ¨æœåŠ¡</button>
            </div>
            <div class="btn-group" id="loadingButtons" style="display: none;">
                <button class="action-btn loading-btn" disabled>ğŸš€ å¯åŠ¨ä¸­...</button>
            </div>
            <div class="btn-group" id="onlineButtons" style="display: none;">
                <button class="action-btn enter-btn" id="enterBtn">ğŸº è¿›å…¥å°çª</button>
                <button class="action-btn stop-btn" id="stopBtn">ğŸ›‘ åœæ­¢</button>
            </div>
        </div>

        <div class="grid-menu">
            <div class="menu-item" id="settingsBtn">
                <div class="menu-icon">âš™ï¸</div>
                <div class="menu-text">å°çªè®¾ç½®</div>
            </div>
            <div class="menu-item" id="accountBtn">
                <div class="menu-icon" id="accountIcon">ğŸ¦</div>
                <div class="menu-text" id="accountText">ç»‘å®šè´¦å·</div>
            </div>
            <div class="menu-item" id="daidaiBtn">
                <div class="menu-icon">ğŸ </div>
                <div class="menu-text">è¿›å…¥å‘†å‘†é¸Ÿ</div>
            </div>
            <div class="menu-item" id="logsBtn">
                <div class="menu-icon">ğŸ“œ</div>
                <div class="menu-text">è¿è¡Œæ—¥å¿—</div>
            </div>
            <div class="menu-item" id="channelBtn">
                <div class="menu-icon">ğŸ“¡</div>
                <div class="menu-text">å¯ç”¨æ¸ é“</div>
            </div>
            <div class="menu-item" id="profileBtn">
                <div class="menu-icon">ğŸ‘¤</div>
                <div class="menu-text">ä¸ªäººä¿¡æ¯</div>
            </div>
        </div>

        <div class="footer-deco">
            Made with â¤ï¸ by Daidai Bird
            <div class="version-info" id="versionInfo"></div>
        </div>
    </div>

    <div class="toast" id="toast"></div>

    <!-- ç™»å½•å¼¹çª— -->
    <div class="modal-overlay" id="loginModal">
        <div class="modal">
            <div class="modal-header">
                <h2>ğŸ¦ ç»‘å®šå‘†å‘†é¸Ÿè´¦å·</h2>
                <button class="modal-close" id="loginClose">&times;</button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label>é‚®ç®±</label>
                    <input type="email" id="loginEmail" placeholder="è¯·è¾“å…¥é‚®ç®±">
                </div>
                <div class="form-group">
                    <label>å¯†ç </label>
                    <input type="password" id="loginPassword" placeholder="è¯·è¾“å…¥å¯†ç ">
                </div>
            </div>
            <div class="modal-footer">
                <button class="modal-btn secondary" id="loginCancel">å–æ¶ˆ</button>
                <button class="modal-btn primary" id="loginSubmit">ç™»å½•ç»‘å®š</button>
            </div>
        </div>
    </div>

    <!-- ç‰ˆæœ¬è®¾ç½®å¼¹çª— -->
    <div class="modal-overlay" id="versionModal">
        <div class="modal" style="max-width: 500px;">
            <div class="modal-header">
                <h2>âš™ï¸ å°çªè®¾ç½®</h2>
                <button class="modal-close" id="versionClose">&times;</button>
            </div>
            <div class="modal-body">
                <!-- ç‰ˆæœ¬é€‰æ‹© -->
                <div class="settings-section">
                    <div class="settings-section-title" style="display: flex; justify-content: space-between; align-items: center;">
                        <span>ğŸ“¦ ç‰ˆæœ¬é€‰æ‹©</span>
                        <button class="rescan-btn" id="rescanBtn" style="font-size: 0.8rem; padding: 4px 10px; background: #e3f2fd; border: 1px solid #90caf9; border-radius: 12px; cursor: pointer;">ğŸ” é‡æ–°æ‰«æ</button>
                    </div>
                    <div class="version-list" id="versionList"></div>
                </div>

                <!-- é€Ÿåº¦ä¼˜åŒ– -->
                <div class="settings-section">
                    <div class="settings-section-title">âš¡ é€Ÿåº¦ä¼˜åŒ–</div>
                    <div class="settings-item">
                        <div class="settings-item-info">
                            <div class="settings-item-name">ä¼˜åŒ–è¿›å…¥é€Ÿåº¦</div>
                            <div class="settings-item-desc">å…³é—­æµè§ˆå™¨ç¼“å­˜ç ´åå™¨ï¼Œä¸ºé™æ€èµ„æºæ·»åŠ ç¼“å­˜å¤´ï¼ŒåŠ å¿«é¡µé¢åŠ è½½é€Ÿåº¦</div>
                        </div>
                        <label class="toggle-switch">
                            <input type="checkbox" id="speedOptToggle">
                            <span class="toggle-slider"></span>
                        </label>
                    </div>
                </div>

                <!-- API èšåˆ -->
                <div class="settings-section">
                    <div class="settings-section-title">ğŸ”— å‘†å‘†é¸ŸAPIèšåˆ</div>
                    <div class="settings-item">
                        <div class="settings-item-info">
                            <div class="settings-item-name">å¯ç”¨APIèšåˆæœåŠ¡</div>
                            <div class="settings-item-desc">è‡ªåŠ¨è½®è¯¢æ‚¨çš„æ‰€æœ‰APIå¯†é’¥ï¼Œè·³è¿‡ä¸å¯ç”¨å¯†é’¥ã€‚API Keyå¡«å†™ï¼šdaidaibird</div>
                            <div class="settings-item-endpoint" id="aggregatorEndpoint" style="display:none;">
                                <strong>èšåˆç«¯ç‚¹ï¼š</strong><code id="aggregatorUrl"></code>
                                <button class="copy-btn" id="copyEndpoint" title="å¤åˆ¶">ğŸ“‹</button>
                            </div>
                            <div class="settings-item-status" id="aggregatorStatus" style="display:none;"></div>
                        </div>
                        <label class="toggle-switch">
                            <input type="checkbox" id="aggregatorToggle">
                            <span class="toggle-slider"></span>
                        </label>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button class="modal-btn secondary" id="versionDone">å…³é—­</button>
            </div>
        </div>
    </div>

    <!-- å¯ç”¨æ¸ é“å¼¹çª— -->
    <div class="modal-overlay" id="channelModal">
        <div class="modal" style="max-width: 500px; max-height: 85vh;">
            <div class="modal-header">
                <h2>ğŸ“¡ å½“å‰å¯ç”¨æ¸ é“</h2>
                <button class="modal-close" id="channelClose">&times;</button>
            </div>
            <div class="modal-body" style="padding: 10px;">
                <div id="channelContent">
                    <div style="text-align:center;padding:20px;">åŠ è½½ä¸­...</div>
                </div>
            </div>
            <div class="modal-footer">
                <button class="modal-btn secondary" id="channelDone">å…³é—­</button>
            </div>
        </div>
    </div>

    <!-- ä¸ªäººä¿¡æ¯å¼¹çª— -->
    <div class="modal-overlay" id="profileModal">
        <div class="modal" style="max-width: 450px;">
            <div class="modal-header">
                <h2>ğŸ‘¤ å‘†å‘†é¸Ÿä¸ªäººä¿¡æ¯</h2>
                <button class="modal-close" id="profileClose">&times;</button>
            </div>
            <div class="modal-body">
                <div id="profileContent">
                    <div style="text-align:center;padding:20px;">åŠ è½½ä¸­...</div>
                </div>
            </div>
            <div class="modal-footer">
                <button class="modal-btn secondary" id="profileDone">å…³é—­</button>
            </div>
        </div>
    </div>

    <!-- æ—¥å¿—å¼¹çª— -->
    <div class="modal-overlay" id="logModal">
        <div class="modal">
            <div class="modal-header">
                <h2>ğŸ“œ è¿è¡Œæ—¥å¿—</h2>
                <button class="modal-close" id="logClose">&times;</button>
            </div>
            <div class="modal-body">
                <div class="log-container" id="logContainer">
                    <div class="log-entry">æš‚æ— æ—¥å¿—</div>
                </div>
            </div>
            <div class="modal-footer">
                <button class="modal-btn secondary" id="logClear">æ¸…ç©º</button>
                <button class="modal-btn primary" id="logDone">å…³é—­</button>
            </div>
        </div>
    </div>

<script>
(function() {
    var API_BASE = '';
    var ST_PORT = 8000;
    var DAIDAI_API = 'https://user.daidaibird.top';

    var isRunning = false;
    var isLoading = false;
    var versionInfo = null;
    var userToken = '';
    var userInfo = null;

    // å®‰å…¨è¯»å– localStorage
    try {
        userToken = localStorage.getItem('daidai_token') || '';
        var savedUser = localStorage.getItem('daidai_user');
        if (savedUser && savedUser !== 'null' && savedUser !== 'undefined') {
            userInfo = JSON.parse(savedUser);
        }
    } catch (e) {
        console.error('localStorage error:', e);
    }

    // Toast æç¤º
    function showToast(message, type) {
        var toast = document.getElementById('toast');
        toast.textContent = message;
        toast.className = 'toast show ' + (type || 'info');
        setTimeout(function() { toast.className = 'toast'; }, 3000);
    }

    // æ›´æ–°è´¦å·UI
    function updateAccountUI() {
        var btn = document.getElementById('accountBtn');
        var icon = document.getElementById('accountIcon');
        var text = document.getElementById('accountText');
        if (userInfo && userToken) {
            btn.style.background = '#e8f5e9';
            btn.style.borderColor = '#a5d6a7';
            icon.textContent = 'âœ…';
            text.textContent = (userInfo.userEmail || '').split('@')[0] || 'å·²ç»‘å®š';
        } else {
            btn.style.background = '';
            btn.style.borderColor = '';
            icon.textContent = 'ğŸ¦';
            text.textContent = 'ç»‘å®šè´¦å·';
        }
    }

    // æ›´æ–°ç•Œé¢çŠ¶æ€
    function updateUI() {
        var offlineButtons = document.getElementById('offlineButtons');
        var loadingButtons = document.getElementById('loadingButtons');
        var onlineButtons = document.getElementById('onlineButtons');
        var statusDot = document.getElementById('statusDot');
        var statusText = document.getElementById('statusText');
        var statusBadge = document.getElementById('statusBadge');
        var versionInfoEl = document.getElementById('versionInfo');

        if (isLoading) {
            offlineButtons.style.display = 'none';
            loadingButtons.style.display = 'flex';
            onlineButtons.style.display = 'none';
            return;
        }

        if (isRunning) {
            offlineButtons.style.display = 'none';
            loadingButtons.style.display = 'none';
            onlineButtons.style.display = 'flex';
            statusText.textContent = 'è¥ä¸šä¸­ (' + ST_PORT + ')';
            statusDot.classList.add('active');
            statusBadge.classList.add('online');
            if (versionInfo && versionInfo.pkgVersion) {
                versionInfoEl.textContent = 'v' + versionInfo.pkgVersion;
            }
        } else {
            offlineButtons.style.display = 'flex';
            loadingButtons.style.display = 'none';
            onlineButtons.style.display = 'none';
            statusText.textContent = 'ä¼‘æ¯ä¸­';
            statusDot.classList.remove('active');
            statusBadge.classList.remove('online');
            versionInfoEl.textContent = '';
        }
    }

    // æ£€æŸ¥çŠ¶æ€
    function checkStatus() {
        fetch(API_BASE + '/api/status')
            .then(function(res) { return res.json(); })
            .then(function(data) {
                isRunning = data.running;
                versionInfo = data.version;
                updateUI();
            })
            .catch(function(err) {
                console.error('Status check failed:', err);
            });
    }

    // å¯åŠ¨æœåŠ¡å™¨
    function startServer() {
        if (isLoading) return;
        isLoading = true;
        updateUI();

        fetch(API_BASE + '/api/start', { method: 'POST' })
            .then(function(res) { return res.json(); })
            .then(function(data) {
                if (data.success) {
                    showToast('å¯åŠ¨æˆåŠŸï¼ğŸ‰', 'success');
                } else {
                    showToast(data.message || 'å¯åŠ¨å¤±è´¥', 'error');
                }
            })
            .catch(function(err) {
                showToast('å¯åŠ¨å¤±è´¥: ' + err.message, 'error');
            })
            .finally(function() {
                isLoading = false;
                checkStatus();
            });
    }

    // åœæ­¢æœåŠ¡å™¨
    function stopServer() {
        if (isLoading) return;
        isLoading = true;
        updateUI();

        fetch(API_BASE + '/api/stop', { method: 'POST' })
            .then(function(res) { return res.json(); })
            .then(function(data) {
                if (data.success) {
                    showToast('æœåŠ¡å·²å…³é—­ ğŸ’¤', 'success');
                } else {
                    showToast(data.message || 'åœæ­¢å¤±è´¥', 'error');
                }
            })
            .catch(function(err) {
                showToast('åœæ­¢å¤±è´¥: ' + err.message, 'error');
            })
            .finally(function() {
                isLoading = false;
                checkStatus();
            });
    }

    // æ‰“å¼€å°çª
    function openTavern() {
        if (isRunning) {
            window.open('http://' + window.location.hostname + ':' + ST_PORT, '_blank');
        } else {
            showToast('è¯·å…ˆå¯åŠ¨æœåŠ¡', 'info');
        }
    }

    // ç™»å½•
    function doLogin() {
        var email = document.getElementById('loginEmail').value.trim();
        var password = document.getElementById('loginPassword').value;

        if (!email || !password) {
            showToast('è¯·è¾“å…¥é‚®ç®±å’Œå¯†ç ', 'error');
            return;
        }

        fetch(DAIDAI_API + '/api/users/login', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ userEmail: email, password: password })
        })
        .then(function(res) { return res.json(); })
        .then(function(data) {
            if (data.code === 200 && data.sate) {
                userToken = data.token;
                userInfo = data.msg;
                localStorage.setItem('daidai_token', userToken);
                localStorage.setItem('daidai_user', JSON.stringify(userInfo));
                updateAccountUI();
                document.getElementById('loginModal').classList.remove('show');
                showToast('ç»‘å®šæˆåŠŸï¼ğŸ‰', 'success');
            } else {
                showToast('ç™»å½•å¤±è´¥ï¼š' + (data.msg || 'è¯·æ£€æŸ¥è´¦å·å¯†ç '), 'error');
            }
        })
        .catch(function(err) {
            showToast('ç™»å½•å¤±è´¥ï¼š' + err.message, 'error');
        });
    }

    // åŠ è½½ç‰ˆæœ¬åˆ—è¡¨
    function loadVersions() {
        var list = document.getElementById('versionList');
        list.innerHTML = '<div style="text-align:center;padding:20px;">åŠ è½½ä¸­...</div>';

        fetch(API_BASE + '/api/versions')
            .then(function(res) { return res.json(); })
            .then(function(data) {
                var html = '';
                data.versions.forEach(function(v) {
                    var isLocal = v.isLocal || v.version.startsWith('local_');
                    var statusText = v.installed ? (v.active ? 'å½“å‰ä½¿ç”¨' : (isLocal ? 'æœ¬åœ°' : 'å·²å®‰è£…')) : 'éœ€å®‰è£…';
                    var statusClass = v.installed ? 'ready' : '';
                    var activeClass = v.active ? 'active' : '';
                    var canUninstall = v.installed && !v.active && !isLocal;
                    html += '<div class="version-item ' + activeClass + '">' +
                        '<div class="version-main" data-version="' + v.version + '" data-installed="' + v.installed + '">' +
                        '<span class="version-name">' + v.name + '</span>' +
                        '<span class="version-status ' + statusClass + '">' + statusText + '</span>' +
                        '</div>';
                    if (canUninstall) {
                        html += '<button class="version-uninstall" data-version="' + v.version + '" title="å¸è½½æ­¤ç‰ˆæœ¬">ğŸ—‘ï¸</button>';
                    }
                    html += '</div>';
                });
                list.innerHTML = html;

                // ç»‘å®šç‰ˆæœ¬ç‚¹å‡»äº‹ä»¶
                list.querySelectorAll('.version-main').forEach(function(item) {
                    item.addEventListener('click', function() {
                        var version = this.getAttribute('data-version');
                        var installed = this.getAttribute('data-installed') === 'true';
                        selectVersion(version, installed);
                    });
                });

                // ç»‘å®šå¸è½½æŒ‰é’®äº‹ä»¶
                list.querySelectorAll('.version-uninstall').forEach(function(btn) {
                    btn.addEventListener('click', function(e) {
                        e.stopPropagation();
                        var version = this.getAttribute('data-version');
                        uninstallVersion(version);
                    });
                });
            })
            .catch(function(err) {
                list.innerHTML = '<div style="color:red;padding:20px;">åŠ è½½å¤±è´¥: ' + err.message + '</div>';
            });
    }

    // é‡æ–°æ‰«ææœ¬åœ°å®‰è£…
    function rescanLocal() {
        showToast('æ­£åœ¨æ‰«ææœ¬åœ°å®‰è£…...', 'info');
        fetch(API_BASE + '/api/versions/rescan', { method: 'POST' })
            .then(function(res) { return res.json(); })
            .then(function(data) {
                showToast(data.message, 'success');
                loadVersions();
            })
            .catch(function(err) {
                showToast('æ‰«æå¤±è´¥: ' + err.message, 'error');
            });
    }

    // å¸è½½ç‰ˆæœ¬
    function uninstallVersion(version) {
        if (isRunning) {
            showToast('è¯·å…ˆåœæ­¢æœåŠ¡å†å¸è½½', 'error');
            return;
        }
        if (!confirm('âš ï¸ è­¦å‘Šï¼šå¸è½½ç‰ˆæœ¬ ' + version + '\n\nè¯·ç¡®ä¿å·²å¤‡ä»½å¥½è¯¥ç‰ˆæœ¬çš„ data æ–‡ä»¶å¤¹ï¼\næ•°æ®ä½ç½®: /root/st-versions/' + version + '/data\n\nå¸è½½åæ‰€æœ‰æ•°æ®å°†è¢«åˆ é™¤ä¸”æ— æ³•æ¢å¤ï¼\n\nç¡®å®šè¦ç»§ç»­å—ï¼Ÿ')) {
            return;
        }
        showToast('æ­£åœ¨å¸è½½...', 'info');
        fetch(API_BASE + '/api/versions/uninstall', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ version: version })
        })
        .then(function(res) { return res.json(); })
        .then(function(data) {
            if (data.success) {
                showToast('å¸è½½æˆåŠŸï¼', 'success');
                loadVersions();
            } else {
                showToast('å¸è½½å¤±è´¥: ' + data.message, 'error');
            }
        })
        .catch(function(err) {
            showToast('å¸è½½å¤±è´¥: ' + err.message, 'error');
        });
    }

    // é€‰æ‹©ç‰ˆæœ¬
    function selectVersion(version, installed) {
        if (isRunning) {
            showToast('è¯·å…ˆåœæ­¢æœåŠ¡å†åˆ‡æ¢ç‰ˆæœ¬', 'error');
            return;
        }

        if (!installed) {
            if (!confirm('ç‰ˆæœ¬ ' + version + ' æœªå®‰è£…ï¼Œæ˜¯å¦ç«‹å³å®‰è£…ï¼Ÿ\nï¼ˆå®‰è£…å¯èƒ½éœ€è¦å‡ åˆ†é’Ÿï¼‰')) {
                return;
            }
            showToast('æ­£åœ¨å®‰è£…ï¼Œè¯·ç¨å€™...', 'info');
            fetch(API_BASE + '/api/versions/install', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ version: version })
            })
            .then(function(res) { return res.json(); })
            .then(function(data) {
                if (data.success) {
                    showToast('å®‰è£…æˆåŠŸï¼', 'success');
                    switchToVersion(version);
                } else {
                    showToast('å®‰è£…å¤±è´¥: ' + data.message, 'error');
                }
            })
            .catch(function(err) {
                showToast('å®‰è£…å¤±è´¥: ' + err.message, 'error');
            });
        } else {
            switchToVersion(version);
        }
    }

    function switchToVersion(version) {
        fetch(API_BASE + '/api/versions/switch', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ version: version })
        })
        .then(function(res) { return res.json(); })
        .then(function(data) {
            if (data.success) {
                showToast('å·²åˆ‡æ¢åˆ° ' + version, 'success');
                loadVersions();
            } else {
                showToast('åˆ‡æ¢å¤±è´¥: ' + data.message, 'error');
            }
        })
        .catch(function(err) {
            showToast('åˆ‡æ¢å¤±è´¥: ' + err.message, 'error');
        });
    }

    // æ¸ é“æ•°æ®ç¼“å­˜
    var channelData = [];
    var currentChannelType = 'å…¨éƒ¨';

    // åŠ è½½æ¸ é“åˆ—è¡¨
    function loadChannels() {
        var content = document.getElementById('channelContent');
        content.innerHTML = '<div style="text-align:center;padding:20px;">åŠ è½½ä¸­...</div>';

        var userData = {};
        if (userInfo) {
            userData = {
                userId: userInfo.userId || userInfo.uid,
                userEmail: userInfo.userEmail,
                password: userInfo.password,
                invitationCode: userInfo.invitationCode
            };
        }

        fetch(DAIDAI_API + '/api/commodity/getPricing', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'Authorization': userToken ? 'Bearer ' + userToken : ''
            },
            body: JSON.stringify(userData)
        })
        .then(function(r) { return r.json(); })
        .then(function(data) {
            if (data.code === 200 && data.msg) {
                channelData = data.msg;
                renderChannels();
            } else {
                content.innerHTML = '<div class="no-data">æš‚æ— æ¸ é“æ•°æ®</div>';
            }
        })
        .catch(function(err) {
            content.innerHTML = '<div style="color:red;padding:20px;">åŠ è½½å¤±è´¥: ' + err.message + '</div>';
        });
    }

    // æ¸²æŸ“æ¸ é“åˆ—è¡¨
    function renderChannels() {
        var content = document.getElementById('channelContent');

        // è·å–æ‰€æœ‰ç±»å‹
        var types = ['å…¨éƒ¨'];
        channelData.forEach(function(item) {
            if (types.indexOf(item.type) === -1) {
                types.push(item.type);
            }
        });

        // è¿‡æ»¤æ•°æ®
        var filtered = currentChannelType === 'å…¨éƒ¨' ? channelData : channelData.filter(function(item) {
            return item.type === currentChannelType;
        });

        var html = '';

        // æ¸²æŸ“æ ‡ç­¾
        html += '<div class="channel-tabs">';
        types.forEach(function(type) {
            html += '<div class="channel-tab' + (type === currentChannelType ? ' active' : '') + '" data-type="' + type + '">' + type + '</div>';
        });
        html += '</div>';

        // æ¸²æŸ“åˆ—è¡¨
        html += '<div class="channel-list">';
        if (filtered.length === 0) {
            html += '<div class="no-data">è¯¥åˆ†ç±»æš‚æ— æ¸ é“</div>';
        } else {
            filtered.forEach(function(item) {
                var isOnline = item.mac === '1';
                html += '<div class="channel-card' + (isOnline ? '' : ' offline') + '">';
                html += '<div class="channel-header">';
                html += '<span class="channel-status ' + (isOnline ? 'online' : 'offline') + '"></span>';
                html += '<span class="channel-title">' + (item.title ? '[' + item.title + '] ' : '') + item.module + '</span>';
                html += '<span class="channel-tag">' + item.type + '</span>';
                html += '</div>';
                if (item.text) {
                    html += '<div class="channel-desc">' + item.text + '</div>';
                }
                html += '<div class="channel-price">';
                if (item.is_price === '1') {
                    html += 'Â¥' + (parseFloat(item.price) * parseFloat(item.num)).toFixed(2) + '/æ¡ (å€ç‡: ' + item.num + ')';
                } else {
                    html += 'æŒ‰é‡è®¡è´¹';
                }
                if (!isOnline) {
                    html += ' <span style="color:#ff9800;">Â· æ£€ä¿®ä¸­</span>';
                }
                html += '</div>';
                html += '</div>';
            });
        }
        html += '</div>';

        content.innerHTML = html;

        // ç»‘å®šæ ‡ç­¾ç‚¹å‡»äº‹ä»¶
        content.querySelectorAll('.channel-tab').forEach(function(tab) {
            tab.addEventListener('click', function() {
                currentChannelType = this.getAttribute('data-type');
                renderChannels();
            });
        });
    }

    // åŠ è½½ä¸ªäººä¿¡æ¯
    function loadProfile() {
        var content = document.getElementById('profileContent');
        content.innerHTML = '<div style="text-align:center;padding:20px;">åŠ è½½ä¸­...</div>';

        var userData = {
            userId: userInfo.userId || userInfo.uid,
            userEmail: userInfo.userEmail,
            password: userInfo.password,
            invitationCode: userInfo.invitationCode
        };

        // å¹¶è¡Œè·å– API å¯†é’¥å’Œä¼˜æƒ åˆ¸
        Promise.all([
            fetch(DAIDAI_API + '/api/general/orders', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': 'Bearer ' + userToken
                },
                body: JSON.stringify({ userData: JSON.stringify(userData), page: 1 })
            }).then(function(r) { return r.json(); }).catch(function() { return { code: 0 }; }),
            fetch(DAIDAI_API + '/api/general/gifts', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': 'Bearer ' + userToken
                },
                body: JSON.stringify(userData)
            }).then(function(r) { return r.json(); }).catch(function() { return { code: 0 }; })
        ]).then(function(results) {
            var ordersData = results[0];
            var giftsData = results[1];
            var html = '';

            // è®¡ç®—æ€»ä½™é¢
            var totalBalance = 0;
            var totalUsed = 0;
            if (ordersData.code === 200 && ordersData.msg && ordersData.msg.length > 0) {
                ordersData.msg.forEach(function(item) {
                    totalBalance += parseFloat(item.balance) || 0;
                    totalUsed += parseFloat(item.utilised) || 0;
                });
            }

            // æ€»ä½™é¢æ˜¾ç¤º
            html += '<div class="profile-section" style="background: linear-gradient(135deg, #e8f5e9, #c8e6c9); border-radius: 15px; padding: 15px; text-align: center;">';
            html += '<div style="font-size: 0.9rem; color: #666; margin-bottom: 5px;">ğŸ’° æ€»å‰©ä½™é¢åº¦</div>';
            html += '<div style="font-size: 2rem; font-weight: bold; color: #2e7d32;">$' + totalBalance.toFixed(2) + '</div>';
            html += '<div style="font-size: 0.8rem; color: #999; margin-top: 5px;">å·²ä½¿ç”¨: $' + totalUsed.toFixed(2) + '</div>';
            html += '</div>';

            // API å¯†é’¥éƒ¨åˆ†
            html += '<div class="profile-section">';
            html += '<div class="profile-section-title">ğŸ”‘ æˆ‘çš„ API å¯†é’¥</div>';
            if (ordersData.code === 200 && ordersData.msg && ordersData.msg.length > 0) {
                ordersData.msg.forEach(function(item) {
                    html += '<div class="api-card">';
                    html += '<div class="api-key">' + item.api_key + '</div>';
                    html += '<div class="api-stats">';
                    html += '<div class="api-stat"><span class="label">å·²ç”¨:</span><span class="value orange">$' + item.utilised + '</span></div>';
                    html += '<div class="api-stat"><span class="label">å‰©ä½™:</span><span class="value green">$' + item.balance + '</span></div>';
                    html += '</div>';
                    html += '</div>';
                });
            } else {
                html += '<div class="no-data">æš‚æ—  API å¯†é’¥</div>';
            }
            html += '</div>';

            // ä¼˜æƒ åˆ¸éƒ¨åˆ†
            html += '<div class="profile-section">';
            html += '<div class="profile-section-title">ğŸ« æˆ‘çš„ä¼˜æƒ åˆ¸</div>';
            if (giftsData.code === 200 && giftsData.msg && giftsData.msg.length > 0) {
                giftsData.msg.forEach(function(item) {
                    html += '<div class="coupon-card">';
                    html += '<div class="coupon-name">' + (item.description || 'ä¼˜æƒ åˆ¸') + '</div>';
                    html += '<div class="coupon-value">Â¥' + item.preferential + '</div>';
                    html += '<div class="coupon-status">' + item.voucher_state + ' Â· ' + item.type + '</div>';
                    html += '</div>';
                });
            } else {
                html += '<div class="no-data">æš‚æ— ä¼˜æƒ åˆ¸</div>';
            }
            html += '</div>';

            content.innerHTML = html;
        }).catch(function(err) {
            content.innerHTML = '<div style="color:red;padding:20px;">åŠ è½½å¤±è´¥: ' + err.message + '</div>';
        });
    }

    // åŠ è½½æ—¥å¿—
    function loadLogs() {
        var container = document.getElementById('logContainer');
        fetch(API_BASE + '/api/logs')
            .then(function(res) { return res.json(); })
            .then(function(data) {
                if (data.logs && data.logs.length > 0) {
                    var html = '';
                    data.logs.forEach(function(log) {
                        html += '<div class="log-entry ' + log.type + '">' +
                            '<span class="time">[' + log.timestamp + ']</span> ' +
                            log.message.replace(/</g, '&lt;').replace(/>/g, '&gt;') +
                            '</div>';
                    });
                    container.innerHTML = html;
                    container.scrollTop = container.scrollHeight;
                } else {
                    container.innerHTML = '<div class="log-entry">æš‚æ— æ—¥å¿—</div>';
                }
            })
            .catch(function(err) {
                container.innerHTML = '<div class="log-entry error">è·å–æ—¥å¿—å¤±è´¥: ' + err.message + '</div>';
            });
    }

    // åŠ è½½è®¾ç½®
    function loadSettings() {
        fetch(API_BASE + '/api/settings')
            .then(function(res) { return res.json(); })
            .then(function(data) {
                // é€Ÿåº¦ä¼˜åŒ–å¼€å…³
                var speedToggle = document.getElementById('speedOptToggle');
                speedToggle.checked = data.speedOptimization || false;

                // APIèšåˆå¼€å…³ - åŸºäºå®é™…è¿è¡ŒçŠ¶æ€ï¼Œè€Œéä¿å­˜çš„é…ç½®
                var aggregatorToggle = document.getElementById('aggregatorToggle');
                var aggregatorEndpoint = document.getElementById('aggregatorEndpoint');
                var aggregatorStatus = document.getElementById('aggregatorStatus');
                var isRunning = data.aggregator && data.aggregator.running;

                aggregatorToggle.checked = isRunning;

                if (isRunning) {
                    aggregatorEndpoint.style.display = 'flex';
                    aggregatorStatus.style.display = 'block';
                    aggregatorStatus.textContent = 'è¿è¡Œä¸­ Â· ' + data.aggregator.keysCount + ' ä¸ªå¯†é’¥å¯ç”¨';
                    var fullEndpoint = window.location.origin + data.aggregator.endpoint;
                    document.getElementById('aggregatorUrl').textContent = fullEndpoint;
                } else {
                    aggregatorEndpoint.style.display = 'none';
                    aggregatorStatus.style.display = 'none';
                }
            })
            .catch(function(err) {
                console.error('åŠ è½½è®¾ç½®å¤±è´¥:', err);
            });
    }

    // åˆ‡æ¢é€Ÿåº¦ä¼˜åŒ–
    function toggleSpeedOptimization(enable) {
        fetch(API_BASE + '/api/settings/speed-optimization', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ enable: enable })
        })
        .then(function(res) { return res.json(); })
        .then(function(data) {
            if (data.success) {
                showToast(data.message, 'success');
            } else {
                showToast(data.message, 'error');
                document.getElementById('speedOptToggle').checked = !enable;
            }
        })
        .catch(function(err) {
            showToast('è®¾ç½®å¤±è´¥: ' + err.message, 'error');
            document.getElementById('speedOptToggle').checked = !enable;
        });
    }

    // åˆ‡æ¢APIèšåˆ
    function toggleAggregator(enable) {
        if (enable) {
            if (!userInfo || !userToken) {
                showToast('è¯·å…ˆç»‘å®šå‘†å‘†é¸Ÿè´¦å·', 'error');
                document.getElementById('aggregatorToggle').checked = false;
                return;
            }
            fetch(API_BASE + '/api/aggregator/start', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ token: userToken, userInfo: userInfo })
            })
            .then(function(res) { return res.json(); })
            .then(function(data) {
                if (data.success) {
                    showToast(data.message + ' Â· ' + data.keysCount + ' ä¸ªå¯†é’¥', 'success');
                    document.getElementById('aggregatorEndpoint').style.display = 'flex';
                    document.getElementById('aggregatorStatus').style.display = 'block';
                    document.getElementById('aggregatorStatus').textContent = 'è¿è¡Œä¸­ Â· ' + data.keysCount + ' ä¸ªå¯†é’¥å¯ç”¨';
                    var fullEndpoint = window.location.origin + data.endpoint;
                    document.getElementById('aggregatorUrl').textContent = fullEndpoint;
                } else {
                    showToast(data.message, 'error');
                    document.getElementById('aggregatorToggle').checked = false;
                }
            })
            .catch(function(err) {
                showToast('å¯åŠ¨å¤±è´¥: ' + err.message, 'error');
                document.getElementById('aggregatorToggle').checked = false;
            });
        } else {
            fetch(API_BASE + '/api/aggregator/stop', { method: 'POST' })
            .then(function(res) { return res.json(); })
            .then(function(data) {
                if (data.success) {
                    showToast(data.message, 'success');
                    document.getElementById('aggregatorEndpoint').style.display = 'none';
                    document.getElementById('aggregatorStatus').style.display = 'none';
                } else {
                    showToast(data.message, 'error');
                    document.getElementById('aggregatorToggle').checked = true;
                }
            })
            .catch(function(err) {
                showToast('åœæ­¢å¤±è´¥: ' + err.message, 'error');
                document.getElementById('aggregatorToggle').checked = true;
            });
        }
    }

    // å¤åˆ¶èšåˆç«¯ç‚¹
    function copyAggregatorEndpoint() {
        var url = document.getElementById('aggregatorUrl').textContent;
        if (navigator.clipboard) {
            navigator.clipboard.writeText(url).then(function() {
                showToast('å·²å¤åˆ¶åˆ°å‰ªè´´æ¿', 'success');
            }).catch(function() {
                showToast('å¤åˆ¶å¤±è´¥', 'error');
            });
        } else {
            var textArea = document.createElement('textarea');
            textArea.value = url;
            document.body.appendChild(textArea);
            textArea.select();
            try {
                document.execCommand('copy');
                showToast('å·²å¤åˆ¶åˆ°å‰ªè´´æ¿', 'success');
            } catch (err) {
                showToast('å¤åˆ¶å¤±è´¥', 'error');
            }
            document.body.removeChild(textArea);
        }
    }

    // é¡µé¢åŠ è½½å®Œæˆåç»‘å®šäº‹ä»¶
    document.addEventListener('DOMContentLoaded', function() {
        console.log('Page loaded, bindingEvents...');

        // è´¦å·æŒ‰é’®
        document.getElementById('accountBtn').addEventListener('click', function() {
            console.log('Account button clicked');
            if (userInfo && userToken) {
                if (confirm('å·²ç»‘å®šè´¦å·ï¼Œæ˜¯å¦é€€å‡ºç™»å½•ï¼Ÿ')) {
                    localStorage.removeItem('daidai_token');
                    localStorage.removeItem('daidai_user');
                    userToken = '';
                    userInfo = null;
                    updateAccountUI();
                    showToast('å·²é€€å‡ºç™»å½•', 'success');
                }
            } else {
                document.getElementById('loginModal').classList.add('show');
            }
        });

        // å¯åŠ¨æŒ‰é’®
        document.getElementById('startBtn').addEventListener('click', startServer);

        // è¿›å…¥å°çªæŒ‰é’®
        document.getElementById('enterBtn').addEventListener('click', openTavern);

        // åœæ­¢æŒ‰é’®
        document.getElementById('stopBtn').addEventListener('click', stopServer);

        // çŠ¶æ€æ ç‚¹å‡»
        document.getElementById('statusBadge').addEventListener('click', openTavern);

        // è®¾ç½®æŒ‰é’®
        document.getElementById('settingsBtn').addEventListener('click', function() {
            document.getElementById('versionModal').classList.add('show');
            loadVersions();
            loadSettings();
        });

        // è¿›å…¥å‘†å‘†é¸Ÿ
        document.getElementById('daidaiBtn').addEventListener('click', function() {
            window.open('https://www.daidaibird.top/', '_blank');
        });

        // æ—¥å¿—æŒ‰é’®
        document.getElementById('logsBtn').addEventListener('click', function() {
            document.getElementById('logModal').classList.add('show');
            loadLogs();
        });

        // å¯ç”¨æ¸ é“æŒ‰é’®
        document.getElementById('channelBtn').addEventListener('click', function() {
            document.getElementById('channelModal').classList.add('show');
            loadChannels();
        });

        // æ¸ é“å¼¹çª—å…³é—­
        document.getElementById('channelClose').addEventListener('click', function() {
            document.getElementById('channelModal').classList.remove('show');
        });
        document.getElementById('channelDone').addEventListener('click', function() {
            document.getElementById('channelModal').classList.remove('show');
        });

        // ä¸ªäººä¿¡æ¯æŒ‰é’®
        document.getElementById('profileBtn').addEventListener('click', function() {
            if (!userInfo || !userToken) {
                showToast('è¯·å…ˆç»‘å®šå‘†å‘†é¸Ÿè´¦å·', 'error');
                return;
            }
            document.getElementById('profileModal').classList.add('show');
            loadProfile();
        });

        // ä¸ªäººä¿¡æ¯å¼¹çª—
        document.getElementById('profileClose').addEventListener('click', function() {
            document.getElementById('profileModal').classList.remove('show');
        });
        document.getElementById('profileDone').addEventListener('click', function() {
            document.getElementById('profileModal').classList.remove('show');
        });

        // ç™»å½•å¼¹çª—
        document.getElementById('loginClose').addEventListener('click', function() {
            document.getElementById('loginModal').classList.remove('show');
        });
        document.getElementById('loginCancel').addEventListener('click', function() {
            document.getElementById('loginModal').classList.remove('show');
        });
        document.getElementById('loginSubmit').addEventListener('click', doLogin);

        // ç‰ˆæœ¬å¼¹çª—
        document.getElementById('versionClose').addEventListener('click', function() {
            document.getElementById('versionModal').classList.remove('show');
        });
        document.getElementById('versionDone').addEventListener('click', function() {
            document.getElementById('versionModal').classList.remove('show');
        });
        document.getElementById('rescanBtn').addEventListener('click', rescanLocal);

        // é€Ÿåº¦ä¼˜åŒ–å¼€å…³
        document.getElementById('speedOptToggle').addEventListener('change', function() {
            toggleSpeedOptimization(this.checked);
        });

        // APIèšåˆå¼€å…³
        document.getElementById('aggregatorToggle').addEventListener('change', function() {
            toggleAggregator(this.checked);
        });

        // å¤åˆ¶èšåˆç«¯ç‚¹
        document.getElementById('copyEndpoint').addEventListener('click', copyAggregatorEndpoint);

        // æ—¥å¿—å¼¹çª—
        document.getElementById('logClose').addEventListener('click', function() {
            document.getElementById('logModal').classList.remove('show');
        });
        document.getElementById('logDone').addEventListener('click', function() {
            document.getElementById('logModal').classList.remove('show');
        });
        document.getElementById('logClear').addEventListener('click', function() {
            fetch(API_BASE + '/api/clear-logs', { method: 'POST' })
                .then(function() {
                    document.getElementById('logContainer').innerHTML = '<div class="log-entry">æ—¥å¿—å·²æ¸…ç©º</div>';
                    showToast('æ—¥å¿—å·²æ¸…ç©º', 'success');
                });
        });

        // ç‚¹å‡»å¼¹çª—èƒŒæ™¯å…³é—­
        document.querySelectorAll('.modal-overlay').forEach(function(overlay) {
            overlay.addEventListener('click', function(e) {
                if (e.target === this) {
                    this.classList.remove('show');
                }
            });
        });

        // åˆå§‹åŒ–
        updateAccountUI();
        checkStatus();
        setInterval(checkStatus, 5000);

        console.log('All events bindingComplete');
    });
})();
</script>
</body>
</html>
